# Contact Shield

## Introduction

This project contains the code snippets of Contact Shield inside Huawei Mobile Services (HMS). The code mainly focuses on: cryptography, BLE operation, key file analysis, and data storage. The project also provides sample code demonstrating how to make the Contact Shield SDK work with Google Exposure Notification.

## Cryptography

The cryptography module describes the generation of the PeriodicKey, DynamicSharingCode (DSC) and SupplementaryData (SD). When starting the Contact Shield service, these cryptography data will be generated by calling `ContactAdvBeaconGenerator.generate()`. The key steps of the generating process are as follows:

1. Obtain the PeriodicKey of the current day. Note that each APP has an exclusive PeriodicKey set. Calling `PeriodicKeyGenerator.getPeriodicKey()` to get the PeriodicKey:

  - If the PeriodicKey of the current day is present in the database, this function will return a copy.
  - Otherwise, call `PeriodicKeyGenerator.cRNG()` to generate a new secure random array as the key and save the key to
    the database. Then return the newly generated key.

2. The generation of DSC depends on the `DSC Key` and `PaddedData`. The DSC Key is derived from the PeriodicKey and generated by calling `DynamicSharingCode.getDscKey()` . PaddedData contains the Epoch Time interval number and is generated by calling  `DynamicSharingCode.generatePaddedData()`. After preparation, a new DSC will be generated by calling `EncryptDecrypt.aesEcbEncrypt()` to encrypt the `PaddedData` with the DSC Key. So the DSC is the encrypted `PaddedData`.

3. To generate SD , we need to prepare `DSC` (please refer to step 2 for DSC generation), `SD Key`, and `metadata`. In class `SupplementaryData`, the function `SupplementaryData.getSdKey()` is used to generate the SD Key, which is also derived from the PeriodicKey, in order to encrypt Bluetooth metadata. The metadata contains the BLE packet format version and transmit power. Implementation details of metadata can be found in `ContactAdvBeaconGenerator`. At the end, `EncryptDecrypt.aesCtrEncrypt()` will be called to generate a new SD.

## BLE operation

Bluetooth Low Energy (BLE) is the underlying channel to exchange DSCs with nearby devices. The related code is grouped together to show how Contact Shield manages the BLE scanner and advertiser. The advertising packet format is detailed in class `ContactBeacon`, with methods `pack()` and `unpack()` to convert between the advertising packet and `ContactBeacon`. When calling `ContactManage.startContact()`, Contact Shield will be started as follows:

1. Check the condition of Bluetooth. Make sure that BLE is supported, and turn on Bluetooth if it is disabled currently.

2. Start BLE scanning by calling `ContactBleScanner.startBleScan()`, and configure the `BLE scanner timer` which will stop scanning in 4 seconds. Implementation details of the BLE scanner can be found in `ContactBleScanner`. This class will call `ContactBeacon.unpack()` when Contact Shield advertisement is found, and pass the newly found `ContactBeacon` to `ContactManager`. Then `ContactManager` saves `DSC/SD` data of `ContactBeacon`, and RSSI to cache.

3. Start BLE advertising. Firstly, call `ContactAdvBeaconGenerator.generate()` to generate `ContactBeacon`, which concatenates `DSC` data (corresponding to the current Epoch Time interval number) and `SD` data (encrypted Bluetooth metadata). Then pass the beacon to `ContactBleAdvertiser.startBleAdv()`. Implementation details of the BLE advertiser can be found in `ContactBleAdvertiser`.

4. When the `BLE scanner timer` expires, stop BLE scanning and flush all the scanned data from cache to the database by calling `ContactDataManage.flushScanDataToDb()`. Then configure the `Contact Shield alarm` in order to start BLE scanning again in 3 to 4 minutes.

5. Every time the `Contact Shield alarm` is triggered, we start the BLE scanner for 4 seconds as described above. At the same time we check the timestamp of the BLE advertiser. If the previous BLE advertiser is already started for more than 10 minutes, then restart the BLE advertiser to update `DSC/SD` data.

## Key file analysis

The `ContactAnalyze` class shows the core process of analyzing key files. The entry for diagnosis and analysis is `ContactAnalyze.analyzeKeyFileList()`. An instance of `DiagnosisConfiguration` is needed to calculate the contact risk value when this API is called.

When a user provides a key file list, the `KeyFileParser.parseFiles()` function will convert each file into a PeriodicKey list. Based on the valid time and lifetime of each PeriodicKey, we will discard these keys which are not in the incubation period.

During the diagnosis process, `ContactAnalyze.getTargetDsc()` generates all DSCs of each key in the lifetime with the help of the cryptography module. These DSCs are renamed as `target DSCs`, and will be compared with the local DSCs that were scanned within the incubation period.

Once any local DSC matches with the `target DSCs`, the current user can be confirmed that has been in contact with someone diagnosed with COVID-19. Base on the number of matched DSCs, Contact Shield calculates the risk value with the specific `DiagnosisConfiguration`. At the same time, `Contact Detail`, `Contact Sketch`, and `Contact Window` will be updated.

After the diagnosis, there are 3 ways to get the diagnosis result:

1. `ContactAnalyze.getContactSketch()` provides the sketch information of the input key files.
2. `ContactAnalyze.getDetailList()` provides detailed information of each matched key in the key files.
3. `ContactAnalyze.getContactWindows()` provides detailed information of each matched key in the `ContactWindow` mode.

Diagnosis details will be saved to the database for subsequent queries, and will be deleted when out of incubation period.

## Data storage

The code just shows what data will be saved to database. The underlying DB is platform dependent and is not opensource. Here are the main tables for Contact Shield to work:

| Class | Table Description |
|----------|-------------------|
| `ScanData` | BLE scanning data, such as DSC, SD, RSSI, etc. |
| `PdkData`  | Historical Periodic Key. |
| `ContactDetailData` | Diagnosis result: ContactDetail, token, etc. |
| `ContactSketchData` | Diagnosis result: ContactSketch, token, etc. |
| `ContactWindowData` | Diagnosis result: ContactWindow, ScanInfoData, etc. |

When to clear data:

1. The historical Periodic Key and diagnosis result will be cleared when a user uninstalls the Contact Shield APP.

2. The historical Periodic Key, diagnosis result, and scanning data will be cleared by `ContactDataManager.checkAndDeleteData()` when out of the incubation period.

3. Users can clear the historical Periodic Key and scanning data on the HMS Core Setting UI. For example, on EMUI:
Setting > Apps > Apps > HMS Core > Gear icon in the upper right corner > COVID-19 Contact Shield > Delete randomized IDs

## Contact Shield Wrapper

An existing APP that already worked with Google Exposure Notification can be easily updated to integrate the Contact Shield SDK. Details can be found in [ContactShieldWrapperReadme](./ContactShieldWrapper/ContacShieldWrapperREADME.md).